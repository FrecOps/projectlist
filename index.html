<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Project Map Dashboard</title>
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body, #map { height:100%; margin:0; }
    /* sidebar styles omitted for brevity */
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar"> <!-- Sidebar markup --> </div>

  <script>
    // CONFIG
    const PA_API_BASE = 'https://www.pythonanywhere.com/api/v0';
    const PA_USERNAME = 'borina';
    const PA_FILE_PATH = '/home/borina/FREC/GIT/projects.json';
    const PA_TOKEN     = '66876b634114ddae7eb34f3d971d5b263e143bef';
    const SECURITY_CODE = 'FREC';

    // ELEMENTS & STATE
    const mapEl = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:22}).addTo(mapEl);
    const syncBtn = document.getElementById('sync-btn');
    const toggleBtn = document.getElementById('toggle-add-btn');
    const formEl = document.getElementById('add-project-form');
    const confirmBtn = document.getElementById('confirm-btn');
    const summaryDiv = document.getElementById('project-summary');
    const sidebarList = document.getElementById('sidebar-list');

    let projects = [];
    let editIndex = null;
    const markers = [];
    const palette = ['#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a','#b15928','#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6'];

    // RENDER FUNCTIONS
    function updateSummary() {
      console.log('updateSummary: projects length =', projects.length);
      const totalMW = projects.reduce((s,p) => s + p.size, 0);
      const totalCap = projects.reduce((s,p) => s + p.capex, 0);
      summaryDiv.textContent = `Projects: ${projects.length} | Capacity: ${totalMW.toFixed(1)} MW | CapEx: $${(totalCap/1e6).toFixed(1)}M`;
    }

    function clearAll() {
      console.log('clearAll: removing markers and clearing list');
      markers.forEach(m => mapEl.removeLayer(m));
      markers.length = 0;
      sidebarList.innerHTML = '';
    }

    function renderAll() {
      console.log('renderAll: rendering', projects);
      clearAll();
      projects.forEach((p, i) => {
        console.log(`renderAll: project[${i}] =`, p);
        const color = palette[i % palette.length];
        const icon = L.divIcon({ html: `<div class="number-marker" style="background:${color}">${i+1}</div>`, iconSize:[26,26], iconAnchor:[13,13] });
        const marker = L.marker([p.lat, p.lng], { icon }).addTo(mapEl);
        marker.bindPopup(`<strong>${p.name}</strong><br>${p.size} MW<br>$${(p.capex/1e6).toFixed(1)}M`);
        markers.push(marker);

        const li = document.createElement('li');
        li.innerHTML = `<div class="header-row">...`;
        sidebarList.appendChild(li);
      });
      updateSummary();
      if (markers.length) {
        console.log('renderAll: fitting map to markers');
        mapEl.fitBounds(markers.map(m => m.getLatLng()), { padding:[40,40] });
      }
    }

    // BACKEND I/O
    async function loadProjects() {
      const url = `${PA_API_BASE}/user/${PA_USERNAME}/files${PA_FILE_PATH}`;
      console.log('loadProjects: fetching URL', url);
      const resp = await fetch(url, { headers:{ Authorization:`Token ${PA_TOKEN}` } });
      console.log('loadProjects: response status', resp.status);
      if (!resp.ok) throw new Error('Load failed: ' + resp.status);
      const data = await resp.json();
      console.log('loadProjects: data', data);
      return data;
    }

    async function saveProjects() {
      const url = `${PA_API_BASE}/user/${PA_USERNAME}/files${PA_FILE_PATH}`;
      console.log('saveProjects: saving URL', url, 'payload', projects);
      const resp = await fetch(url, { method:'PUT', headers:{ Authorization:`Token ${PA_TOKEN}`, 'Content-Type':'application/json' }, body: JSON.stringify(projects) });
      console.log('saveProjects: response status', resp.status);
      if (!resp.ok) throw new Error('Save failed: ' + resp.status);
    }

    // EVENT HANDLERS WITH LOGGING
    syncBtn.onclick = async () => {
      console.log('syncBtn clicked');
      try { await saveProjects(); console.log('sync complete'); alert('Saved!'); }
      catch (e) { console.error('sync error', e); alert(e); }
    };

    toggleBtn.onclick = () => {
      console.log('toggleBtn clicked, form visible:', formEl.style.display);
      if (prompt('Enter code') !== SECURITY_CODE) return console.warn('toggle denied');
      formEl.reset(); editIndex = null; confirmBtn.textContent = 'Confirm Add';
      formEl.style.display = formEl.style.display==='block'?'none':'block';
      toggleBtn.textContent = formEl.style.display==='block'?'Hide Form':'Add Project +';
    };

    sidebarList.onclick = async e => {
      console.log('sidebarList click', e.target);
      const btn = e.target.closest('button.action-btn');
      if (!btn) return;
      if (prompt('Enter code') !== SECURITY_CODE) return console.warn('action denied');
      const idx = +btn.dataset.index;
      const action = btn.dataset.action;
      console.log(`action ${action} on index`, idx);
      if (action === 'delete') {
        projects.splice(idx,1); renderAll();
        try { await saveProjects(); console.log('delete sync complete'); } catch(e) { console.error('delete sync error', e); }
        return;
      }
      // edit
      const p = projects[idx]; console.log('editing project', p);
      ['name','lat','lng','size','capex'].forEach(k => document.getElementById('proj-'+k).value = p[k]);
      editIndex = idx; formEl.style.display='block'; confirmBtn.textContent='Save Changes'; toggleBtn.textContent='Hide Form';
    };

    formEl.onsubmit = async e => {
      e.preventDefault(); console.log('form submit, editIndex =', editIndex);
      if (prompt('Enter code') !== SECURITY_CODE) return console.warn('submit denied');
      const obj = {
        name : document.getElementById('proj-name').value.trim(),
        lat  : parseFloat(document.getElementById('proj-lat').value),
        lng  : parseFloat(document.getElementById('proj-lng').value),
        size : Math.round(parseFloat(document.getElementById('proj-size').value)*10)/10,
        capex: Math.round(parseFloat(document.getElementById('proj-capex').value))
      };
      console.log('form data object', obj);
      if (!obj.name || isNaN(obj.lat) || isNaN(obj.lng) || isNaN(obj.size) || isNaN(obj.capex)) return console.warn('invalid input');
      if (editIndex != null) projects[editIndex] = obj; else projects.push(obj);
      renderAll(); formEl.reset(); formEl.style.display='none'; editIndex=null; toggleBtn.textContent='Add Project +';
      try { await saveProjects(); console.log('save after submit complete'); } catch(e) { console.error('save after submit error', e); }
    };

    // BOOTSTRAP
    loadProjects()
      .then(data => { projects = data; console.log('initial load complete'); })
      .catch(err => { console.error('initial load error', err); projects=[]; })
      .finally(() => { renderAll(); console.log('initial render complete'); });
  </script>
</body>
</html>
