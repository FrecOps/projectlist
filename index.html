<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Project Map Dashboard</title>
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body, #map { height:100%; margin:0; }
    #sidebar {
      position:absolute; top:20px; left:20px;
      width:360px; background:#fff; padding:12px;
      border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.25);
      max-height:80vh; overflow-y:auto; font-family:'Segoe UI', sans-serif;
      font-size:.9rem; z-index:1000;
    }
    #sidebar h4 { margin:0 0 10px; font-size:1.2rem; border-bottom:1px solid #eee; padding-bottom:6px; color:#333; }
    #sidebar .summary { font-weight:600; margin-bottom:12px; color:#555; }
    .btn {
      width:100%; padding:6px; margin-bottom:6px; font-weight:700; border:none;
      border-radius:4px; background:#0d6efd; color:#fff; cursor:pointer;
      transition:background .2s;
    }
    .btn:hover { background:#0b5ed7; }
    #add-project-form { display:none; margin-bottom:12px; }
    #add-project-form input, #add-project-form button {
      width:100%; padding:6px; margin-bottom:6px; border:1px solid #ccc;
      border-radius:4px; font-size:.9rem;
    }
    .action-btn {
      margin-left:6px; padding:2px 6px; font-size:.8rem; border:none;
      border-radius:3px; background:#6c757d; color:#fff;
    }
    .action-btn:hover { background:#5a6268; }
    #sidebar ul { list-style:none; padding:0; margin:0; }
    #sidebar li {
      background:#fafafa; margin-bottom:10px; padding:8px;
      border-radius:6px; transition:background .2s;
    }
    #sidebar li:hover { background:#f0f4f8; }
    .header-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
    .header-left { display:flex; align-items:center; }
    .swatch { width:14px; height:14px; border-radius:3px; margin-right:8px;
      border:1px solid #999; flex-shrink:0;
    }
    .number { width:22px; text-align:center; margin-right:8px;
      font-weight:600; color:#333;
    }
    .title { font-weight:600; color:#222; }
    .details { margin-left:30px; font-size:.85rem; color:#555; }
    .number-marker {
      display:flex; align-items:center; justify-content:center;
      width:26px; height:26px; line-height:26px; border-radius:50%;
      font-size:.85rem; font-weight:700; color:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,0.4);
      background:#0d6efd;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h4>Projects Dashboard</h4>
    <div id="project-summary" class="summary"></div>
    <button id="sync-btn" class="btn">Save to Server</button>
    <button id="toggle-add-btn" class="btn">Add Project +</button>
    <form id="add-project-form">
      <input id="proj-name"  type="text"   placeholder="Name (required)" required />
      <input id="proj-lat"   type="number" step="any" placeholder="Latitude (required)" required />
      <input id="proj-lng"   type="number" step="any" placeholder="Longitude (required)" required />
      <input id="proj-size"  type="number" step="any" placeholder="System Size MW" required />
      <input id="proj-capex" type="number" step="any" placeholder="CapEx $" required />
      <button id="confirm-btn" type="submit">Confirm Add</button>
    </form>
    <ul id="sidebar-list"></ul>
  </div>

  <script>
    // CONFIG
    const PA_API_BASE = 'https://www.pythonanywhere.com/api/v0';
    const PA_USERNAME = 'borina';
    const PA_FILE_PATH = '/home/borina/FREC/GIT/projects.json';
    const PA_TOKEN     = '66876b634114ddae7eb34f3d971d5b263e143bef'; // ⚠️ don't expose in production
    const SECURITY_CODE = 'FREC';

    // ELEMENTS & STATE
    const mapEl = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:22}).addTo(mapEl);
    const syncBtn     = document.getElementById('sync-btn');
    const toggleBtn   = document.getElementById('toggle-add-btn');
    const formEl      = document.getElementById('add-project-form');
    const confirmBtn  = document.getElementById('confirm-btn');
    const summaryDiv  = document.getElementById('project-summary');
    const sidebarList = document.getElementById('sidebar-list');

    let projects = [], editIndex = null;
    const markers = [];
    const palette = ['#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a','#b15928','#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6'];

    // RENDERING
    function updateSummary(){
      console.log('updateSummary: count=', projects.length);
      const m = projects.reduce((s,p)=>s+p.size, 0);
      const c = projects.reduce((s,p)=>s+p.capex, 0);
      summaryDiv.textContent = `Projects: ${projects.length} | Capacity: ${m.toFixed(1)} MW | CapEx: $${(c/1e6).toFixed(1)}M`;
    }
    function clearAll(){ markers.forEach(m=>mapEl.removeLayer(m)); markers.length=0; sidebarList.innerHTML=''; }
    function renderAll(){
      console.log('renderAll'); clearAll();
      projects.forEach((p,i)=>{
        console.log('project',i,p);
        const color = palette[i%palette.length];
        const icon = L.divIcon({html:`<div class="number-marker" style="background:${color}">${i+1}</div>\`, iconSize:[26,26], iconAnchor:[13,13]});
        const mk = L.marker([p.lat,p.lng],{icon}).addTo(mapEl).bindPopup(
          `<strong>${p.name}</strong><br>${p.size} MW<br>$${(p.capex/1e6).toFixed(1)}M`
        );
        markers.push(mk);
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="header-row">
            <div class="header-left">
              <span class="swatch" style="background:${color}"></span>
              <b class="number">${i+1}</b>
              <span class="title">${p.name}</span>
            </div>
            <div>
              <button class="action-btn" data-action="edit" data-index="${i}">Edit</button>
              <button class="action-btn" data-action="delete" data-index="${i}">Del</button>
            </div>
          </div>
          <div class="details">${p.size} MW | $${(p.capex/1e6).toFixed(1)}M</div>`;
        sidebarList.appendChild(li);
      });
      updateSummary();
      if(markers.length) mapEl.fitBounds(markers.map(m=>m.getLatLng()),{padding:[40,40]});
    }

    // BACKEND I/O
    async function loadProjects(){
      const url = `${PA_API_BASE}/user/${PA_USERNAME}/files${PA_FILE_PATH}`;
      console.log('loadProjects',url);
      const r = await fetch(url,{headers:{Authorization:`Token ${PA_TOKEN}`}});
      console.log('load status',r.status);
      if(!r.ok) throw new Error('Load failed');
      const d = await r.json(); console.log('data',d); return d;
    }
    async function saveProjects(){
      const url = `${PA_API_BASE}/user/${PA_USERNAME}/files${PA_FILE_PATH}`;
      console.log('saveProjects',url,projects);
      const r = await fetch(url,{
        method:'PUT',
        headers:{Authorization:`Token ${PA_TOKEN}`, 'Content-Type':'application/json'},
        body:JSON.stringify(projects)
      });
      console.log('save status',r.status);
      if(!r.ok) throw new Error('Save failed');
    }

    // HANDLERS
    syncBtn.onclick = async ()=>{ console.log('sync'); try{await saveProjects();console.log('synced');}catch(e){console.error(e);} };
    toggleBtn.onclick = ()=>{
      console.log('toggle'); if(prompt('Code?')!==SECURITY_CODE)return; formEl.reset(); editIndex=null; confirmBtn.textContent='Confirm Add';
      formEl.style.display = formEl.style.display==='block'?'none':'block'; toggleBtn.textContent = formEl.style.display==='block'?'Hide Form':'Add Project +';
    };
    sidebarList.onclick = async e=>{
      console.log('sidebar click',e.target);
      const btn = e.target.closest('button.action-btn'); if(!btn)return;
      if(prompt('Code?')!==SECURITY_CODE)return;
      const i = +btn.dataset.index; const a = btn.dataset.action;
      console.log(a,i);
      if(a==='delete'){ projects.splice(i,1); renderAll(); try{await saveProjects();}catch(e){console.error(e);} return; }
      const p = projects[i]; console.log('edit',p);
      ['name','lat','lng','size','capex'].forEach(k=>document.getElementById('proj-'+k).value=p[k]);
      editIndex=i; formEl.style.display='block'; confirmBtn.textContent='Save Changes'; toggleBtn.textContent='Hide Form';
    };
    formEl.onsubmit = async e=>{
      e.preventDefault(); console.log('submit',editIndex);
      if(prompt('Code?')!==SECURITY_CODE)return;
      const obj={
        name:document.getElementById('proj-name').value.trim(),
        lat:parseFloat(document.getElementById('proj-lat').value),
        lng:parseFloat(document.getElementById('proj-lng').value),
        size:Math.round(parseFloat(document.getElementById('proj-size').value)*10)/10,
        capex:Math.round(parseFloat(document.getElementById('proj-capex').value))
      };
      console.log('obj',obj);
      if(!obj.name||isNaN(obj.lat)||isNaN(obj.lng)||isNaN(obj.size)||isNaN(obj.capex))return;
      if(editIndex!=null)projects[editIndex]=obj; else projects.push(obj);
      renderAll(); formEl.reset(); formEl.style.display='none'; editIndex=null; toggleBtn.textContent='Add Project +';
      try{await saveProjects();}catch(e){console.error(e);}    };

    // INIT
    loadProjects().then(d=>{projects=d;console.log('init load');}).catch(e=>{console.error('init err',e);projects=[];}).finally(()=>{renderAll();console.log('init render');});
  </script>
</body>
</html>
