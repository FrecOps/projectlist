<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Project Map with Sidebar & GitHub Sync</title>
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* ... existing styles ... */
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h4>Projects Dashboard</h4>
    <div id="project-summary"></div>
    <button id="sync-btn" class="btn">Sync Projects to GitHub</button>
    <button id="toggle-add-btn" class="btn">Add Project +</button>
    <form id="add-project-form">
      <!-- input fields -->
    </form>
    <ul id="sidebar-list"></ul>
  </div>

  <script>
  // --- Element refs ---
  const syncBtn     = document.getElementById('sync-btn');
  const toggleBtn   = document.getElementById('toggle-add-btn');
  const form        = document.getElementById('add-project-form');
  const confirmBtn  = document.getElementById('confirm-btn');
  const summaryDiv  = document.getElementById('project-summary');
  const sidebarList = document.getElementById('sidebar-list');

  // --- Map setup ---
  const map = L.map('map').setView([37.8, -96], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 22 }).addTo(map);

  // --- Data & palette ---
  let projects = [];
  // No default projects; rely solely on projects.json\ n  // If you want an empty start, projects will be empty array if load fails
  
  // Remove defaultProjects definition
  const palette = ["#1f78b4","#33a02c","#e31a1c","#ff7f00","#6a3d9a","#b15928","#a6cee3","#b2df8a","#fb9a99","#fdbf6f","#cab2d6"];
  const markers = [];
  let editIndex = null;

  // --- Rendering helpers ---
  function updateSummary() {
    const totalMW = projects.reduce((sum,p) => sum + p.size, 0);
    const totalCap = projects.reduce((sum,p) => sum + p.capex, 0);
    summaryDiv.textContent = `Projects: ${projects.length} | Capacity: ${totalMW.toFixed(1)} MW | CapEx: $${(totalCap/1e6).toFixed(1)}M`;
  }
  function clearAll() {
    markers.forEach(m => map.removeLayer(m));
    markers.length = 0;
    sidebarList.innerHTML = '';
  }
  function renderAll() {
    clearAll();
    projects.forEach((p,i) => {
      const color = palette[i % palette.length];
      const icon = L.divIcon({ html: `<div class="number-marker" style="background:${color}">${i+1}</div>`, iconSize:[26,26], iconAnchor:[13,13] });
      const marker = L.marker([p.lat,p.lng], { icon }).addTo(map);
      marker.bindPopup(`<strong>${p.name}</strong><br/>${p.size} MW<br/>$${(p.capex/1e6).toFixed(1)}M`);
      markers.push(marker);

      const li = document.createElement('li');
      li.innerHTML = `
        <div class="header-row">
          <div class="header-left"><span class="swatch" style="background:${color}"></span><b class="number">${i+1}</b><span class="title">${p.name}</span></div>
          <div>
            <button class="action-btn" data-action="edit" data-index="${i}">Edit</button>
            <button class="action-btn" data-action="delete" data-index="${i}">Del</button>
          </div>
        </div>
        <div class="details">${p.size} MW | $${(p.capex/1e6).toFixed(1)}M</div>
      `;
      sidebarList.appendChild(li);
    });
    updateSummary();
    if (markers.length) map.fitBounds(markers.map(m => m.getLatLng()), { padding:[40,40] });
  }

  // --- Load from projects.json ---
  fetch('projects.json')
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => { projects = data; })
    .catch(() => { projects = [...defaultProjects]; })
    .finally(renderAll);

    // --- Handlers: toggle form visibility with security ---
  toggleBtn.onclick = () => {
    const code = prompt('Enter security code to add/edit projects');
    if (code !== 'FREC') { alert('Invalid code'); return; }
    form.reset();
    editIndex = null;
    confirmBtn.textContent = 'Confirm Add';
    form.style.display = form.style.display === 'block' ? 'none' : 'block';
    toggleBtn.textContent = form.style.display === 'block' ? 'Hide Form' : 'Add Project +';
  };

  // --- Handler: edit or delete actions ---
  sidebarList.onclick = e => {
    const btn = e.target.closest('button.action-btn');
    if (!btn) return;
    const idx = parseInt(btn.dataset.index);
    const action = btn.dataset.action;
    const code = prompt('Enter security code to proceed');
    if (code !== 'FREC') { alert('Invalid code'); return; }
    if (action === 'delete') {
      projects.splice(idx, 1);
      renderAll();
    } else if (action === 'edit') {
      const p = projects[idx];
      document.getElementById('proj-name').value = p.name;
      document.getElementById('proj-lat').value = p.lat;
      document.getElementById('proj-lng').value = p.lng;
      document.getElementById('proj-size').value = p.size;
      document.getElementById('proj-capex').value = p.capex;
      editIndex = idx;
      form.style.display = 'block';
      confirmBtn.textContent = 'Save Changes';
      toggleBtn.textContent = 'Hide Form';
    }
  };

  // --- Handler: add or save project submission ---
  form.onsubmit = e => {
    e.preventDefault();
    const code = prompt('Enter security code to add or save project');
    if (code !== 'FREC') { alert('Invalid code'); return; }
    const name = document.getElementById('proj-name').value.trim();
    const lat = parseFloat(document.getElementById('proj-lat').value);
    const lng = parseFloat(document.getElementById('proj-lng').value);
    const size = Math.round(parseFloat(document.getElementById('proj-size').value) * 10) / 10;
    const capex = Math.round(parseFloat(document.getElementById('proj-capex').value));
    if (!name || isNaN(lat) || isNaN(lng) || isNaN(size) || isNaN(capex)) return;
    const newProj = { name, lat, lng, size, capex };
    if (editIndex != null) projects[editIndex] = newProj;
    else projects.push(newProj);
    renderAll();
    form.reset();
    form.style.display = 'none';
    editIndex = null;
    toggleBtn.textContent = 'Add Project +';
  };
</script>
<script src="sync.js"></script>
</body>
</html>
<script src="sync.js"></script>
</body>
</html>
